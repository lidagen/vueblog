<template><div><h2 id="bigdecimal-源码分析-jdk8" tabindex="-1"><a class="header-anchor" href="#bigdecimal-源码分析-jdk8"><span>BigDecimal 源码分析 JDK8</span></a></h2>
<h3 id="概述" tabindex="-1"><a class="header-anchor" href="#概述"><span>概述</span></a></h3>
<ul>
<li>
<p><code v-pre>float</code>和<code v-pre>double</code>类型的主要设计目标是为了科学计算和工程计算。他们执行二进制浮点运算，这是为了在广域数值范围上提供较为精确的快速近似计算而精心设计的。它们没有提供完全精确的结果，所以不应该被用于要求精确结果的场合。商业计算往往要求结果精确，这时候需要用到<code v-pre>BigDecimal</code></p>
</li>
<li>
<p><code v-pre>BigDecimal</code>继承 <code v-pre>Number</code>抽象类, 实现<code v-pre>Comparable</code>接口。<code v-pre>Number</code>提供了把对象转为int long byte float double的方法。<code v-pre>Comparable</code>实现了BigDecimal间比较的方法。</p>
</li>
</ul>
<h3 id="变量" tabindex="-1"><a class="header-anchor" href="#变量"><span>变量</span></a></h3>
<div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre v-pre><code><span class="line"><span class="token comment">//整数域（超过 18 位时使用）</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BigInteger</span> intVal<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">//整数域long型表示，整数域在 long 能够表示的范围内使用，超出能表示范围会被赋为 Long.MIN_VALUE，</span></span>
<span class="line"><span class="token comment">//代表整数域此时使用intVal 来表示</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">transient</span> <span class="token keyword">long</span> intCompact<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">//表示小数位数</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> scale<span class="token punctuation">;</span> </span>
<span class="line"></span>
<span class="line"><span class="token comment">//值的有效位数，不包含正负符号</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">int</span> precision<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">//表示的缓存。该值只赋值一次。</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token class-name">String</span> stringCache<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">INFLATED</span> <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token constant">MIN_VALUE</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">BigInteger</span> <span class="token constant">INFLATED_BIGINT</span> <span class="token operator">=</span> <span class="token class-name">BigInteger</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token constant">INFLATED</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MAX_COMPACT_DIGITS</span> <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StringBuilderHelper</span><span class="token punctuation">></span></span></span>
<span class="line">    threadLocalStringBuilderHelper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StringBuilderHelper</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">protected</span> <span class="token class-name">StringBuilderHelper</span> <span class="token function">initialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilderHelper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul>
<li>从变量来看，BigDecimal 是用两个变量来表示整数与小数的。这种方法避免了float 和 double小数精度问题</li>
</ul>
<h3 id="重要相关类" tabindex="-1"><a class="header-anchor" href="#重要相关类"><span>重要相关类</span></a></h3>
<h4 id="roundingmode" tabindex="-1"><a class="header-anchor" href="#roundingmode"><span><strong>RoundingMode</strong></span></a></h4>
<ul>
<li>该类是一个枚举类，枚举了 8 种舍入类型：
<ul>
<li><code v-pre>CEILING</code> 向正无穷舍入</li>
<li><code v-pre>FLOOR</code> 向负无穷舍入</li>
<li><code v-pre>DOWN</code> 向 0 舍入</li>
<li><code v-pre>UP</code> 与 DOWN 相反</li>
<li><code v-pre>HALF_UP</code> 五入</li>
<li><code v-pre>HALF_DOWN</code> 五舍</li>
<li><code v-pre>HALF_EVEN</code> 五向偶数方向舍入</li>
<li><code v-pre>UNNECESSARY</code> 表示一定会得到精确结果，得不到时抛异常</li>
</ul>
</li>
</ul>
<img :src="$withBase('/javaweb/rounding-mode-table.png')" alt="dock">
<h4 id="mathcontext" tabindex="-1"><a class="header-anchor" href="#mathcontext"><span><strong>MathContext</strong></span></a></h4>
<ul>
<li>封装了精度及舍入规则，用于算数运算,预定义的一些规则：</li>
</ul>
<div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre v-pre><code><span class="line"><span class="token comment">//精度为 0，相当于没有配置</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">MathContext</span> <span class="token constant">UNLIMITED</span> <span class="token operator">=</span></span>
<span class="line">                <span class="token keyword">new</span> <span class="token class-name">MathContext</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">RoundingMode</span><span class="token punctuation">.</span><span class="token constant">HALF_UP</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 精度为 7，舍入策略为 HALF_EVEN</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">MathContext</span> <span class="token constant">DECIMAL32</span> <span class="token operator">=</span></span>
<span class="line">                <span class="token keyword">new</span> <span class="token class-name">MathContext</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token class-name">RoundingMode</span><span class="token punctuation">.</span><span class="token constant">HALF_EVEN</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 精度为 16，舍入策略为 HALF_EVEN</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">MathContext</span> <span class="token constant">DECIMAL64</span> <span class="token operator">=</span></span>
<span class="line">                <span class="token keyword">new</span> <span class="token class-name">MathContext</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token class-name">RoundingMode</span><span class="token punctuation">.</span><span class="token constant">HALF_EVEN</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 精度为 34，舍入策略为 HALF_EVEN</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">MathContext</span> <span class="token constant">DECIMAL128</span> <span class="token operator">=</span></span>
<span class="line">                <span class="token keyword">new</span> <span class="token class-name">MathContext</span><span class="token punctuation">(</span><span class="token number">34</span><span class="token punctuation">,</span> <span class="token class-name">RoundingMode</span><span class="token punctuation">.</span><span class="token constant">HALF_EVEN</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul>
<li>精度7 表示123.4567，后面的舍弃。</li>
</ul>
<h4 id="biginteger" tabindex="-1"><a class="header-anchor" href="#biginteger"><span><strong>BigInteger</strong></span></a></h4>
<ul>
<li>任意精度的整数。底层存储方式也是 bits 位，与基本类型的区别在于，基本类型 <code v-pre>int</code> 固定 32bits，<code v-pre>BigInteger</code> 的 bits 存储在一个 <code v-pre>int[]</code> 中，所以他可以表示很大的整数。比如 2^128 的二进制表示是 100...000(1+128个0) 一共 129 位，存放在长度为 <code v-pre>Math.ceil(129.0/32)</code> 的数组中。</li>
</ul>
<h3 id="构造器" tabindex="-1"><a class="header-anchor" href="#构造器"><span>构造器</span></a></h3>
<div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre v-pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line">*BigDecimal(String val) 最终实现是</span>
<span class="line">*public BigDecimal(char[] in, int offset, int len, MathContext mc)<span class="token punctuation">{</span><span class="token punctuation">}</span>构造器</span>
<span class="line">*/</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token class-name">String</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">(</span>val<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> val<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token class-name">String</span> val<span class="token punctuation">,</span> <span class="token class-name">MathContext</span> mc<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">(</span>val<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> val<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mc<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> in<span class="token punctuation">,</span> <span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">(</span>in<span class="token punctuation">,</span>offset<span class="token punctuation">,</span>len<span class="token punctuation">,</span><span class="token class-name">MathContext</span><span class="token punctuation">.</span><span class="token constant">UNLIMITED</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token doc-comment comment">/**</span>
<span class="line">*这个方法最终目的是区分正负数，给变量 scale intVal intCompact precision赋值</span>
<span class="line">*/</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> in<span class="token punctuation">,</span> <span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">,</span> <span class="token class-name">MathContext</span> mc<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 判断起始位合理性.</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">+</span> len <span class="token operator">></span> in<span class="token punctuation">.</span>length <span class="token operator">||</span> offset <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NumberFormatException</span><span class="token punctuation">(</span><span class="token string">"Bad offset or len arguments for char[] input."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">int</span> prec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                 <span class="token comment">// record precision value</span></span>
<span class="line">    <span class="token keyword">int</span> scl <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                  <span class="token comment">// record scale value</span></span>
<span class="line">    <span class="token keyword">long</span> rs <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                  <span class="token comment">// the compact value in long</span></span>
<span class="line">    <span class="token class-name">BigInteger</span> rb <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>         <span class="token comment">// the inflated value in BigInteger</span></span>
<span class="line">    <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//判断正负+ - 负数isneg为true</span></span>
<span class="line">        <span class="token keyword">boolean</span> isneg <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>          <span class="token comment">// assume positive</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>in<span class="token punctuation">[</span>offset<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'-'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            isneg <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>               <span class="token comment">// leading minus means negative</span></span>
<span class="line">            offset<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line">            len<span class="token operator">--</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>in<span class="token punctuation">[</span>offset<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'+'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// leading + allowed</span></span>
<span class="line">            offset<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line">            len<span class="token operator">--</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">boolean</span> dot <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>             <span class="token comment">// true when there is a '.'</span></span>
<span class="line">        <span class="token keyword">long</span> exp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                    <span class="token comment">// exponent</span></span>
<span class="line">        <span class="token keyword">char</span> c<span class="token punctuation">;</span>                          <span class="token comment">// current character</span></span>
<span class="line">        <span class="token comment">//判断char数组长度是否超过long最大长度</span></span>
<span class="line">        <span class="token keyword">boolean</span> isCompact <span class="token operator">=</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;=</span> <span class="token constant">MAX_COMPACT_DIGITS</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//char长度在long内</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>isCompact<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//循环</span></span>
<span class="line">            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> len <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> offset<span class="token operator">++</span><span class="token punctuation">,</span> len<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                c <span class="token operator">=</span> in<span class="token punctuation">[</span>offset<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token char">'0'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// have zero</span></span>
<span class="line">                    <span class="token keyword">if</span> <span class="token punctuation">(</span>prec <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">                        prec <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rs <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                        rs <span class="token operator">*=</span> <span class="token number">10</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token operator">++</span>prec<span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span> <span class="token comment">// else digit is a redundant leading zero</span></span>
<span class="line">                    <span class="token keyword">if</span> <span class="token punctuation">(</span>dot<span class="token punctuation">)</span></span>
<span class="line">                        <span class="token operator">++</span>scl<span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">>=</span> <span class="token char">'1'</span> <span class="token operator">&amp;&amp;</span> c <span class="token operator">&lt;=</span> <span class="token char">'9'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// have digit</span></span>
<span class="line">                    <span class="token keyword">int</span> digit <span class="token operator">=</span> c <span class="token operator">-</span> <span class="token char">'0'</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">if</span> <span class="token punctuation">(</span>prec <span class="token operator">!=</span> <span class="token number">1</span> <span class="token operator">||</span> rs <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">                        <span class="token operator">++</span>prec<span class="token punctuation">;</span> <span class="token comment">// prec unchanged if preceded by 0s</span></span>
<span class="line">                    rs <span class="token operator">=</span> rs <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">+</span> digit<span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">if</span> <span class="token punctuation">(</span>dot<span class="token punctuation">)</span></span>
<span class="line">                        <span class="token operator">++</span>scl<span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token char">'.'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">// have dot</span></span>
<span class="line">                    <span class="token comment">// have dot</span></span>
<span class="line">                    <span class="token keyword">if</span> <span class="token punctuation">(</span>dot<span class="token punctuation">)</span> <span class="token comment">// two dots</span></span>
<span class="line">                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NumberFormatException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    dot <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token function">isDigit</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// slow path</span></span>
<span class="line">                    <span class="token keyword">int</span> digit <span class="token operator">=</span> <span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token function">digit</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">if</span> <span class="token punctuation">(</span>digit <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token keyword">if</span> <span class="token punctuation">(</span>prec <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">                            prec <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rs <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                            rs <span class="token operator">*=</span> <span class="token number">10</span><span class="token punctuation">;</span></span>
<span class="line">                            <span class="token operator">++</span>prec<span class="token punctuation">;</span></span>
<span class="line">                        <span class="token punctuation">}</span> <span class="token comment">// else digit is a redundant leading zero</span></span>
<span class="line">                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token keyword">if</span> <span class="token punctuation">(</span>prec <span class="token operator">!=</span> <span class="token number">1</span> <span class="token operator">||</span> rs <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">                            <span class="token operator">++</span>prec<span class="token punctuation">;</span> <span class="token comment">// prec unchanged if preceded by 0s</span></span>
<span class="line">                        rs <span class="token operator">=</span> rs <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">+</span> digit<span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                    <span class="token keyword">if</span> <span class="token punctuation">(</span>dot<span class="token punctuation">)</span></span>
<span class="line">                        <span class="token operator">++</span>scl<span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token char">'e'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token char">'E'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    exp <span class="token operator">=</span> <span class="token function">parseExp</span><span class="token punctuation">(</span>in<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token comment">// Next test is required for backwards compatibility</span></span>
<span class="line">                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> exp <span class="token operator">!=</span> exp<span class="token punctuation">)</span> <span class="token comment">// overflow</span></span>
<span class="line">                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NumberFormatException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// [saves a test]</span></span>
<span class="line">                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NumberFormatException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>prec <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// no digits found</span></span>
<span class="line">                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NumberFormatException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// Adjust scale if exp is not zero.</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>exp <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// had significant exponent</span></span>
<span class="line">                scl <span class="token operator">=</span> <span class="token function">adjustScale</span><span class="token punctuation">(</span>scl<span class="token punctuation">,</span> exp<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            rs <span class="token operator">=</span> isneg <span class="token operator">?</span> <span class="token operator">-</span>rs <span class="token operator">:</span> rs<span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">int</span> mcp <span class="token operator">=</span> mc<span class="token punctuation">.</span>precision<span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">int</span> drop <span class="token operator">=</span> prec <span class="token operator">-</span> mcp<span class="token punctuation">;</span> <span class="token comment">// prec has range [1, MAX_INT], mcp has range [0, MAX_INT];</span></span>
<span class="line">                                    <span class="token comment">// therefore, this subtract cannot overflow</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>mcp <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> drop <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// do rounding</span></span>
<span class="line">                <span class="token keyword">while</span> <span class="token punctuation">(</span>drop <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    scl <span class="token operator">=</span> <span class="token function">checkScaleNonZero</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> scl <span class="token operator">-</span> drop<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    rs <span class="token operator">=</span> <span class="token function">divideAndRound</span><span class="token punctuation">(</span>rs<span class="token punctuation">,</span> <span class="token constant">LONG_TEN_POWERS_TABLE</span><span class="token punctuation">[</span>drop<span class="token punctuation">]</span><span class="token punctuation">,</span> mc<span class="token punctuation">.</span>roundingMode<span class="token punctuation">.</span>oldMode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    prec <span class="token operator">=</span> <span class="token function">longDigitLength</span><span class="token punctuation">(</span>rs<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    drop <span class="token operator">=</span> prec <span class="token operator">-</span> mcp<span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//char长度不在long内</span></span>
<span class="line">            <span class="token keyword">char</span> coeff<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> len <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> offset<span class="token operator">++</span><span class="token punctuation">,</span> len<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                c <span class="token operator">=</span> in<span class="token punctuation">[</span>offset<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">// have digit</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">>=</span> <span class="token char">'0'</span> <span class="token operator">&amp;&amp;</span> c <span class="token operator">&lt;=</span> <span class="token char">'9'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token function">isDigit</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token comment">// First compact case, we need not to preserve the character</span></span>
<span class="line">                    <span class="token comment">// and we can just compute the value in place.</span></span>
<span class="line">                    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token char">'0'</span> <span class="token operator">||</span> <span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token function">digit</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token keyword">if</span> <span class="token punctuation">(</span>prec <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                            coeff<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">;</span></span>
<span class="line">                            prec <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                            coeff<span class="token punctuation">[</span>idx<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">;</span></span>
<span class="line">                            <span class="token operator">++</span>prec<span class="token punctuation">;</span></span>
<span class="line">                        <span class="token punctuation">}</span> <span class="token comment">// else c must be a redundant leading zero</span></span>
<span class="line">                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token keyword">if</span> <span class="token punctuation">(</span>prec <span class="token operator">!=</span> <span class="token number">1</span> <span class="token operator">||</span> idx <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">                            <span class="token operator">++</span>prec<span class="token punctuation">;</span> <span class="token comment">// prec unchanged if preceded by 0s</span></span>
<span class="line">                        coeff<span class="token punctuation">[</span>idx<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                    <span class="token keyword">if</span> <span class="token punctuation">(</span>dot<span class="token punctuation">)</span></span>
<span class="line">                        <span class="token operator">++</span>scl<span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">continue</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                <span class="token comment">// have dot</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token char">'.'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token comment">// have dot</span></span>
<span class="line">                    <span class="token keyword">if</span> <span class="token punctuation">(</span>dot<span class="token punctuation">)</span> <span class="token comment">// two dots</span></span>
<span class="line">                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NumberFormatException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    dot <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">continue</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                <span class="token comment">// exponent expected</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">!=</span> <span class="token char">'e'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>c <span class="token operator">!=</span> <span class="token char">'E'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NumberFormatException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                exp <span class="token operator">=</span> <span class="token function">parseExp</span><span class="token punctuation">(</span>in<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">// Next test is required for backwards compatibility</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> exp <span class="token operator">!=</span> exp<span class="token punctuation">)</span> <span class="token comment">// overflow</span></span>
<span class="line">                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NumberFormatException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// [saves a test]</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token comment">// here when no characters left</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>prec <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// no digits found</span></span>
<span class="line">                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NumberFormatException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// Adjust scale if exp is not zero.</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>exp <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// had significant exponent</span></span>
<span class="line">                scl <span class="token operator">=</span> <span class="token function">adjustScale</span><span class="token punctuation">(</span>scl<span class="token punctuation">,</span> exp<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token comment">// Remove leading zeros from precision (digits count)</span></span>
<span class="line">            rb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigInteger</span><span class="token punctuation">(</span>coeff<span class="token punctuation">,</span> isneg <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> prec<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            rs <span class="token operator">=</span> <span class="token function">compactValFor</span><span class="token punctuation">(</span>rb<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">int</span> mcp <span class="token operator">=</span> mc<span class="token punctuation">.</span>precision<span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>mcp <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>prec <span class="token operator">></span> mcp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>rs <span class="token operator">==</span> <span class="token constant">INFLATED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">int</span> drop <span class="token operator">=</span> prec <span class="token operator">-</span> mcp<span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">while</span> <span class="token punctuation">(</span>drop <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                        scl <span class="token operator">=</span> <span class="token function">checkScaleNonZero</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> scl <span class="token operator">-</span> drop<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        rb <span class="token operator">=</span> <span class="token function">divideAndRoundByTenPow</span><span class="token punctuation">(</span>rb<span class="token punctuation">,</span> drop<span class="token punctuation">,</span> mc<span class="token punctuation">.</span>roundingMode<span class="token punctuation">.</span>oldMode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        rs <span class="token operator">=</span> <span class="token function">compactValFor</span><span class="token punctuation">(</span>rb<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token keyword">if</span> <span class="token punctuation">(</span>rs <span class="token operator">!=</span> <span class="token constant">INFLATED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                            prec <span class="token operator">=</span> <span class="token function">longDigitLength</span><span class="token punctuation">(</span>rs<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                            <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token punctuation">}</span></span>
<span class="line">                        prec <span class="token operator">=</span> <span class="token function">bigDigitLength</span><span class="token punctuation">(</span>rb<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        drop <span class="token operator">=</span> prec <span class="token operator">-</span> mcp<span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>rs <span class="token operator">!=</span> <span class="token constant">INFLATED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">int</span> drop <span class="token operator">=</span> prec <span class="token operator">-</span> mcp<span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">while</span> <span class="token punctuation">(</span>drop <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                        scl <span class="token operator">=</span> <span class="token function">checkScaleNonZero</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> scl <span class="token operator">-</span> drop<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        rs <span class="token operator">=</span> <span class="token function">divideAndRound</span><span class="token punctuation">(</span>rs<span class="token punctuation">,</span> <span class="token constant">LONG_TEN_POWERS_TABLE</span><span class="token punctuation">[</span>drop<span class="token punctuation">]</span><span class="token punctuation">,</span> mc<span class="token punctuation">.</span>roundingMode<span class="token punctuation">.</span>oldMode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        prec <span class="token operator">=</span> <span class="token function">longDigitLength</span><span class="token punctuation">(</span>rs<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        drop <span class="token operator">=</span> prec <span class="token operator">-</span> mcp<span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                    rb <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArrayIndexOutOfBoundsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NumberFormatException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NegativeArraySizeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NumberFormatException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>scale <span class="token operator">=</span> scl<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>precision <span class="token operator">=</span> prec<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>intCompact <span class="token operator">=</span> rs<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>intVal <span class="token operator">=</span> rb<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="方法" tabindex="-1"><a class="header-anchor" href="#方法"><span>方法</span></a></h3>
<h4 id="加-add" tabindex="-1"><a class="header-anchor" href="#加-add"><span><font color=#A23400 ><strong>加 add</strong></font></span></a></h4>
<div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre v-pre><code><span class="line"><span class="token comment">//无精度,结果是4.5585522</span></span>
<span class="line"><span class="token class-name">BigDecimal</span> add <span class="token operator">=</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">3.22522</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">1.3333322</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">//设置精度和舍入类型，结果是4.5585522，原因是设置精度后生成新的对象，需要BigDecimal接收</span></span>
<span class="line"><span class="token class-name">BigDecimal</span> add <span class="token operator">=</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">3.22522</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">1.3333322</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">add<span class="token punctuation">.</span><span class="token function">setScale</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token class-name">RoundingMode</span><span class="token punctuation">.</span><span class="token constant">HALF_UP</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">//正确方案 1</span></span>
<span class="line"><span class="token class-name">BigDecimal</span> add <span class="token operator">=</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">3.22522</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">1.3333322</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">BigDecimal</span> addScale <span class="token operator">=</span> add<span class="token punctuation">.</span><span class="token function">setScale</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token class-name">RoundingMode</span><span class="token punctuation">.</span><span class="token constant">HALF_UP</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">//正确方案 2</span></span>
<span class="line"><span class="token class-name">BigDecimal</span> add <span class="token operator">=</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">3.22522</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">1.3333322</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">                                            <span class="token punctuation">.</span><span class="token function">setScale</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token class-name">RoundingMode</span><span class="token punctuation">.</span><span class="token constant">HALF_UP</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="减-subtract" tabindex="-1"><a class="header-anchor" href="#减-subtract"><span><font color=#A23400 ><strong>减 subtract</strong></font></span></a></h4>
<div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre v-pre><code><span class="line"><span class="token class-name">BigDecimal</span> subtract <span class="token operator">=</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">3.22522</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">5.3333322</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">                                           <span class="token punctuation">.</span><span class="token function">setScale</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token class-name">RoundingMode</span><span class="token punctuation">.</span><span class="token constant">HALF_UP</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="乘-multiply" tabindex="-1"><a class="header-anchor" href="#乘-multiply"><span><font color=#A23400 ><strong>乘 multiply</strong></font></span></a></h4>
<div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre v-pre><code><span class="line"><span class="token class-name">BigDecimal</span> multiply <span class="token operator">=</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">3.22522</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">5.3333322</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">                                                    <span class="token punctuation">.</span><span class="token function">setScale</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token class-name">RoundingMode</span><span class="token punctuation">.</span><span class="token constant">HALF_UP</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="除-divide" tabindex="-1"><a class="header-anchor" href="#除-divide"><span><font color=#A23400 ><strong>除 divide</strong></font></span></a></h4>
<div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre v-pre><code><span class="line"><span class="token comment">//这种方式除不尽情况下会报错 ArithmeticException</span></span>
<span class="line"><span class="token class-name">BigDecimal</span> divide <span class="token operator">=</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">3.22522</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">5.3333322</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">                                                    <span class="token punctuation">.</span><span class="token function">setScale</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token class-name">RoundingMode</span><span class="token punctuation">.</span><span class="token constant">HALF_UP</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">//正确写法</span></span>
<span class="line"><span class="token class-name">BigDecimal</span> divide <span class="token operator">=</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">9.22522</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">5.3333322</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token class-name">RoundingMode</span><span class="token punctuation">.</span><span class="token constant">HALF_UP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                         </span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container warning">
<p class="hint-container-title">Warning</p>
<p>除法在计算之前就要设置精度和舍入类型，不能等计算完成以后设置。因为在设置精度之前存在无法除尽的情况</p>
</div>
<h4 id="绝对值-abs" tabindex="-1"><a class="header-anchor" href="#绝对值-abs"><span><font color=#A23400 ><strong>绝对值 abs</strong></font></span></a></h4>
<div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre v-pre><code><span class="line"><span class="token comment">//绝对值也可设置精度和舍入类型</span></span>
<span class="line"><span class="token class-name">BigDecimal</span> abs <span class="token operator">=</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">9.22522</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setScale</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token class-name">RoundingMode</span><span class="token punctuation">.</span><span class="token constant">HALF_UP</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="总结" tabindex="-1"><a class="header-anchor" href="#总结"><span>总结</span></a></h3>
<ul>
<li>商业计算使用BigDecimal。</li>
<li>总是使用compareTo()比较两个BigDecimal的值，不要使用equals()</li>
<li>尽量使用参数类型为String的构造函数,避免精度问题。</li>
<li>BigDecimal都是不可变的（immutable）的，在进行每一步运算时，都会产生一个新的对象，所以在做加减乘除运算时千万要保存操作后的值。</li>
<li>除法使用时，要加上精度和舍入类型入参，避免除不尽报ArithmeticException异常</li>
</ul>
</div></template>


