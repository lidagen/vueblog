{"code":"(window.webpackJsonp=window.webpackJsonp||[]).push([[102],{454:function(t,a,s){\"use strict\";s.r(a);var e=s(43),v=Object(e.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s(\"ContentSlotsDistributor\",{attrs:{\"slot-key\":t.$parent.slotKey}},[s(\"h2\",{attrs:{id:\"企业级解决方案\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#企业级解决方案\"}},[t._v(\"#\")]),t._v(\" 企业级解决方案\")]),t._v(\" \"),s(\"h3\",{attrs:{id:\"缓存预热\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#缓存预热\"}},[t._v(\"#\")]),t._v(\" 缓存预热\")]),t._v(\" \"),s(\"h4\",{attrs:{id:\"现象\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#现象\"}},[t._v(\"#\")]),t._v(\" 现象\")]),t._v(\" \"),s(\"ul\",[s(\"li\",[t._v(\"服务器启动后快速宕机\")])]),t._v(\" \"),s(\"h4\",{attrs:{id:\"原因\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#原因\"}},[t._v(\"#\")]),t._v(\" 原因\")]),t._v(\" \"),s(\"ul\",[s(\"li\",[t._v(\"请求数量较大\")]),t._v(\" \"),s(\"li\",[t._v(\"主从之间数据吞吐量比较大，数据同步操作频率高\")])]),t._v(\" \"),s(\"h4\",{attrs:{id:\"解决方案\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#解决方案\"}},[t._v(\"#\")]),t._v(\" 解决方案\")]),t._v(\" \"),s(\"ul\",[s(\"li\",[t._v(\"前置准备工作\\n\"),s(\"ul\",[s(\"li\",[t._v(\"日常例行统计数据访问记录，统计访问频度较高的热度数据\")]),t._v(\" \"),s(\"li\",[t._v(\"利用LRU数据删除策略，构建数据保留队列\")])])]),t._v(\" \"),s(\"li\",[t._v(\"准备工作\\n\"),s(\"ul\",[s(\"li\",[t._v(\"将统计结果中的数据分类，根据级别，redis优先加载级别较高的热点数据\")]),t._v(\" \"),s(\"li\",[t._v(\"利用分布式多服务器同时进行数据读取，提速数据加载过程\")])])]),t._v(\" \"),s(\"li\",[t._v(\"实施\\n\"),s(\"ul\",[s(\"li\",[t._v(\"使用脚本固定触发数据预热过程\")]),t._v(\" \"),s(\"li\",[t._v(\"如果条件允许，使用CDN\")])])])]),t._v(\" \"),s(\"h3\",{attrs:{id:\"缓存雪崩\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#缓存雪崩\"}},[t._v(\"#\")]),t._v(\" 缓存雪崩\")]),t._v(\" \"),s(\"h4\",{attrs:{id:\"现象-2\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#现象-2\"}},[t._v(\"#\")]),t._v(\" 现象\")]),t._v(\" \"),s(\"ul\",[s(\"li\",[t._v(\"系统运行过程突然数据库访问激增\")]),t._v(\" \"),s(\"li\",[t._v(\"导致数据库崩溃引发应用服务器崩溃\")])]),t._v(\" \"),s(\"h4\",{attrs:{id:\"原因-2\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#原因-2\"}},[t._v(\"#\")]),t._v(\" 原因\")]),t._v(\" \"),s(\"ul\",[s(\"li\",[t._v(\"在一个较短时间内，缓存中较多的\"),s(\"strong\",[t._v(\"key集中过期\")])]),t._v(\" \"),s(\"li\",[t._v(\"大量请求未命中redis,从而给数据库带来大的压力\")]),t._v(\" \"),s(\"li\",[t._v(\"应用服务器，redis,数据库的重启效果不明显\")])]),t._v(\" \"),s(\"h4\",{attrs:{id:\"解决方案-2\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#解决方案-2\"}},[t._v(\"#\")]),t._v(\" 解决方案\")]),t._v(\" \"),s(\"ul\",[s(\"li\",[t._v(\"解决方案1\\n\"),s(\"ul\",[s(\"li\",[t._v(\"更多页面静态化处理\")]),t._v(\" \"),s(\"li\",[t._v(\"构建多级缓存架构\\n\"),s(\"ul\",[s(\"li\",[t._v(\"nginx+redis+ehcache\")])])]),t._v(\" \"),s(\"li\",[t._v(\"对数据库查询进行优化\")]),t._v(\" \"),s(\"li\",[t._v(\"灾难预警：\\n\"),s(\"ul\",[s(\"li\",[t._v(\"监控CPU使用\")]),t._v(\" \"),s(\"li\",[t._v(\"内存容量\")]),t._v(\" \"),s(\"li\",[t._v(\"平均响应时间\")]),t._v(\" \"),s(\"li\",[t._v(\"线程数\")])])]),t._v(\" \"),s(\"li\",[t._v(\"服务限流、熔断\")])])]),t._v(\" \"),s(\"li\",[t._v(\"解决方案2\\n\"),s(\"ul\",[s(\"li\",[t._v(\"LRU和LFU的切换\")]),t._v(\" \"),s(\"li\",[t._v(\"数据有效期策略\\n\"),s(\"ul\",[s(\"li\",[t._v(\"根据业务不同，key失效时间错峰\")]),t._v(\" \"),s(\"li\",[t._v(\"过期时间使用固定时间+随机值，稀释集中到期key数量\")])])]),t._v(\" \"),s(\"li\",[t._v(\"定期维护，对即将过期的数据做访问量统计，确认是否需要延期\")]),t._v(\" \"),s(\"li\",[t._v(\"加锁：慎用\")])])])]),t._v(\" \"),s(\"h3\",{attrs:{id:\"缓存击穿\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#缓存击穿\"}},[t._v(\"#\")]),t._v(\" 缓存击穿\")]),t._v(\" \"),s(\"h4\",{attrs:{id:\"现象-3\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#现象-3\"}},[t._v(\"#\")]),t._v(\" 现象\")]),t._v(\" \"),s(\"ul\",[s(\"li\",[t._v(\"系统运**行中，数据库访问激增\")]),t._v(\" \"),s(\"li\",[t._v(\"redis服务器无大量key过期，CPU正常，内存平稳无波动\")]),t._v(\" \"),s(\"li\",[t._v(\"数据库崩溃\")])]),t._v(\" \"),s(\"h4\",{attrs:{id:\"原因-3\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#原因-3\"}},[t._v(\"#\")]),t._v(\" 原因\")]),t._v(\" \"),s(\"ul\",[s(\"li\",[s(\"strong\",[t._v(\"单个key\")]),t._v(\"过期，而这个key访问量很大\")]),t._v(\" \"),s(\"li\",[t._v(\"大量对这个key的请求，redis未命中，短时间对数据库发起大量访问\")])]),t._v(\" \"),s(\"h4\",{attrs:{id:\"解决方案-3\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#解决方案-3\"}},[t._v(\"#\")]),t._v(\" 解决方案\")]),t._v(\" \"),s(\"ul\",[s(\"li\",[t._v(\"预先对可能的高热key加大过期时长\")]),t._v(\" \"),s(\"li\",[t._v(\"实时对流量激增的key延长过期时间或者设置永久key\")]),t._v(\" \"),s(\"li\",[t._v(\"对可能的高峰访问前，提前刷新数据有效期，确保key在访问时不过期\")]),t._v(\" \"),s(\"li\",[t._v(\"分布式锁，防止被击穿，但是也影响性能\")])]),t._v(\" \"),s(\"h3\",{attrs:{id:\"缓存穿透\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#缓存穿透\"}},[t._v(\"#\")]),t._v(\" 缓存穿透\")]),t._v(\" \"),s(\"h4\",{attrs:{id:\"现象-4\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#现象-4\"}},[t._v(\"#\")]),t._v(\" 现象\")]),t._v(\" \"),s(\"ul\",[s(\"li\",[t._v(\"应用服务器访问增加，redis命中\"),s(\"strong\",[t._v(\"逐步降低\")])]),t._v(\" \"),s(\"li\",[t._v(\"redis服务器CPU占用激增\")]),t._v(\" \"),s(\"li\",[t._v(\"数据库压力激增\")]),t._v(\" \"),s(\"li\",[t._v(\"数据库崩溃\")])]),t._v(\" \"),s(\"h4\",{attrs:{id:\"原因-4\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#原因-4\"}},[t._v(\"#\")]),t._v(\" 原因\")]),t._v(\" \"),s(\"ul\",[s(\"li\",[t._v(\"大量非正常URL，要获取的数据根本不存在\")]),t._v(\" \"),s(\"li\",[t._v(\"redis中没有这些数据，所以去请求数据库\")]),t._v(\" \"),s(\"li\",[t._v(\"可能的黑客攻击\")])]),t._v(\" \"),s(\"h4\",{attrs:{id:\"解决方案1\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#解决方案1\"}},[t._v(\"#\")]),t._v(\" 解决方案1\")]),t._v(\" \"),s(\"ul\",[s(\"li\",[t._v(\"redis对没有的数据缓存null,设置较短过期时间（<5min）\")]),t._v(\" \"),s(\"li\",[t._v(\"白名单策略\\n\"),s(\"ul\",[s(\"li\",[t._v(\"提前预热各种分类数据id对于的bitmaps,当数据正常放行，数据异常拦截（效率较低）\")]),t._v(\" \"),s(\"li\",[t._v(\"布隆过滤器（布隆过滤器命中率这种情况可以忽略）\")])])]),t._v(\" \"),s(\"li\",[t._v(\"实施监控\\n\"),s(\"ul\",[s(\"li\",[t._v(\"监控redis命中率与null数据的占比\\n\"),s(\"ul\",[s(\"li\",[t._v(\"非活动时间波动，通常检测3～5倍，超过5纳入排查\")]),t._v(\" \"),s(\"li\",[t._v(\"活动时间波动，通村检测10～50倍，超过50纳入排查\")])])])])]),t._v(\" \"),s(\"li\",[t._v(\"key加密\\n\"),s(\"ul\",[s(\"li\",[t._v(\"问题出现后，临时启动防灾业务key,对key进行业务层传输加密，设定校验程序，对key校验（例如每天随机分配60个加密串，挑选2～3个，混淆在页面数据id中，发现key不满足规则，驳回请求）\")])])])]),t._v(\" \"),s(\"h3\",{attrs:{id:\"数据库与缓存双写一致性\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#数据库与缓存双写一致性\"}},[t._v(\"#\")]),t._v(\" 数据库与缓存双写一致性\")]),t._v(\" \"),s(\"ul\",[s(\"li\",[t._v(\"双写一致性，主要是在更新数据库的操作，如何保证数据库更新的值和缓存更新的值保持一致\")]),t._v(\" \"),s(\"li\",[t._v(\"理论上了来说，对缓存数据设置过期时间，是保证最终一致性的解决方案，所有的写操作都是依数据库为准，如果数据库写成功，缓存更新失败，那只要到达过期时间，自然会从数据库取新值回填。这里讨论不依赖过期时间的三种解决方案\")])]),t._v(\" \"),s(\"h4\",{attrs:{id:\"三种更新策略\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#三种更新策略\"}},[t._v(\"#\")]),t._v(\" 三种更新策略\")]),t._v(\" \"),s(\"ul\",[s(\"li\",[t._v(\"先更新数据库，再更新缓存\")]),t._v(\" \"),s(\"li\",[t._v(\"先删除缓存，再更新数据库\")]),t._v(\" \"),s(\"li\",[t._v(\"先更新数据库，再删除缓存\")])]),t._v(\" \"),s(\"h4\",{attrs:{id:\"方案1-先更新数据库，再更新缓存\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#方案1-先更新数据库，再更新缓存\"}},[t._v(\"#\")]),t._v(\" 方案1——先更新数据库，再更新缓存\")]),t._v(\" \"),s(\"ul\",[s(\"li\",[t._v(\"这套方案是大家普遍反对的，有如下两个原因\\n\"),s(\"ul\",[s(\"li\",[t._v(\"原因一，线程安全角度\\n\"),s(\"ul\",[s(\"li\",[t._v(\"两个线程对数据修改，有可能导致数据库和缓存不一致\")])])])])])]),t._v(\" \"),s(\"div\",{staticClass:\"language-sh extra-class\"},[s(\"pre\",{pre:!0,attrs:{class:\"language-sh\"}},[s(\"code\",[s(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"#1线程A更新了数据库\")]),t._v(\"\\n\"),s(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"#2线程B更新了数据库\")]),t._v(\"\\n\"),s(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"#3线程B更新了缓存\")]),t._v(\"\\n\"),s(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"#4线程A更新了缓存\")]),t._v(\"\\n\")])])]),s(\"ul\",[s(\"li\",[t._v(\"原因二，业务场景角度\\n\"),s(\"ul\",[s(\"li\",[t._v(\"场景1，如果是一个写多读少的业务，频繁的更新缓存是浪费性能的\")]),t._v(\" \"),s(\"li\",[t._v(\"场景2，如果写入数据库的值，并不直接写入缓存，而是需要复杂计算的，那么每次写入再计算不如删除更合适\")])])])]),t._v(\" \"),s(\"h4\",{attrs:{id:\"方案2-先删除缓存，再更新数据库\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#方案2-先删除缓存，再更新数据库\"}},[t._v(\"#\")]),t._v(\" 方案2——先删除缓存，再更新数据库\")]),t._v(\" \"),s(\"ul\",[s(\"li\",[t._v(\"这套方案也会导致不一致\")])]),t._v(\" \"),s(\"div\",{staticClass:\"language-sh extra-class\"},[s(\"pre\",{pre:!0,attrs:{class:\"language-sh\"}},[s(\"code\",[s(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"# 1请求A删除缓存，准备修改数据库\")]),t._v(\"\\n\"),s(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"# 2请求B查询发现缓存不存在\")]),t._v(\"\\n\"),s(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"# 3请求B去数据库查到了旧值\")]),t._v(\"\\n\"),s(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"# 4请求B把旧值写入缓存\")]),t._v(\"\\n\"),s(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"# 5请求A将新值写入数据库\")]),t._v(\"\\n\")])])]),s(\"ul\",[s(\"li\",[t._v(\"这种问题可以采用延时双删策略\")])]),t._v(\" \"),s(\"div\",{staticClass:\"language-java extra-class\"},[s(\"pre\",{pre:!0,attrs:{class:\"language-java\"}},[s(\"code\",[t._v(\"#伪代码\\n\"),s(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[t._v(\"public\")]),t._v(\" \"),s(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[t._v(\"void\")]),t._v(\" \"),s(\"span\",{pre:!0,attrs:{class:\"token function\"}},[t._v(\"write\")]),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"(\")]),s(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[t._v(\"String\")]),t._v(\" key\"),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\",\")]),s(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[t._v(\"Object\")]),t._v(\" data\"),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\")\")]),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"{\")]),t._v(\"\\n    redis\"),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\".\")]),s(\"span\",{pre:!0,attrs:{class:\"token function\"}},[t._v(\"del\")]),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"(\")]),t._v(\"key\"),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\")\")]),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\";\")]),t._v(\"\\n    db\"),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\".\")]),s(\"span\",{pre:!0,attrs:{class:\"token function\"}},[t._v(\"update\")]),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"(\")]),t._v(\"data\"),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\")\")]),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\";\")]),t._v(\"\\n    \"),s(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[t._v(\"Thread\")]),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\".\")]),s(\"span\",{pre:!0,attrs:{class:\"token function\"}},[t._v(\"sleep\")]),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"(\")]),s(\"span\",{pre:!0,attrs:{class:\"token number\"}},[t._v(\"1000\")]),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\")\")]),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\";\")]),t._v(\"\\n    redis\"),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\".\")]),s(\"span\",{pre:!0,attrs:{class:\"token function\"}},[t._v(\"del\")]),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"(\")]),t._v(\"key\"),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\")\")]),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\";\")]),t._v(\"\\n\"),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"}\")]),t._v(\"\\n\")])])]),s(\"ul\",[s(\"li\",[t._v(\"这个方案可以将1秒内造成的缓存脏数据再次删除，这个1秒如何确定，需要评估自己业务逻辑耗时\")]),t._v(\" \"),s(\"li\",[t._v(\"若数据库是读写分离架构，还会出现问题\")])]),t._v(\" \"),s(\"div\",{staticClass:\"language-sh extra-class\"},[s(\"pre\",{pre:!0,attrs:{class:\"language-sh\"}},[s(\"code\",[s(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"# 1请求A删除缓存，准备修改数据库\")]),t._v(\"\\n\"),s(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"# 2请求A将新值写入数据库\")]),t._v(\"\\n\"),s(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"# 3请求B查询缓存发现，缓存没有值\")]),t._v(\"\\n\"),s(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"# 4请求B去从库查询，这时，还没有完成主从同步，因此查询到的是旧值\")]),t._v(\"\\n\"),s(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"# 5请求B将旧值写入缓存\")]),t._v(\"\\n\"),s(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"# 6数据库完成主从同步，从库变为新值\")]),t._v(\"\\n\")])])]),s(\"h4\",{attrs:{id:\"方案3-先更新数据库，再删除缓存\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#方案3-先更新数据库，再删除缓存\"}},[t._v(\"#\")]),t._v(\" 方案3——先更新数据库，再删除缓存\")]),t._v(\" \"),s(\"ul\",[s(\"li\",[t._v(\"这种方案也有并发问题\")])]),t._v(\" \"),s(\"div\",{staticClass:\"language-sh extra-class\"},[s(\"pre\",{pre:!0,attrs:{class:\"language-sh\"}},[s(\"code\",[s(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"#1缓存刚好失效\")]),t._v(\"\\n\"),s(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"#2请求A查询数据库，得到一个旧值\")]),t._v(\"\\n\"),s(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"#3请求B将新值写入\")]),t._v(\"\\n\"),s(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"#4请求B删除缓存\")]),t._v(\"\\n\"),s(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"#5请求A将旧值写入缓存\")]),t._v(\"\\n\")])])]),s(\"ul\",[s(\"li\",[t._v(\"这种情况发生概率有多高\\n\"),s(\"ul\",[s(\"li\",[t._v(\"发生上述情况有一个先天条件，就是步骤3的写操作要比步骤2读操作耗时更短，才有可能步骤4先与步骤5。但是数据库读操作速度远大于写操作（读写分离的意义就是读操作快，消耗资源小）。因此步骤3耗时比步骤2更短，这一情况很难发生\")])])]),t._v(\" \"),s(\"li\",[t._v(\"如果一定要解决这个问题\\n\"),s(\"ul\",[s(\"li\",[t._v(\"设置缓存过期时间，并采用策略2异步延时删除策略\")])])])]),t._v(\" \"),s(\"h4\",{attrs:{id:\"还有其它不一致原因吗\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#还有其它不一致原因吗\"}},[t._v(\"#\")]),t._v(\" 还有其它不一致原因吗\")]),t._v(\" \"),s(\"ul\",[s(\"li\",[t._v(\"策略2和策略3都存在一个问题，就是删除缓存失败导致的不一致\")]),t._v(\" \"),s(\"li\",[t._v(\"如何解决：\\n\"),s(\"ul\",[s(\"li\",[t._v(\"方案1\")])])])]),t._v(\" \"),s(\"div\",{staticClass:\"language-sh extra-class\"},[s(\"pre\",{pre:!0,attrs:{class:\"language-sh\"}},[s(\"code\",[s(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"#更新数据库数据\")]),t._v(\"\\n\"),s(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"#缓存因问题未删除\")]),t._v(\"\\n\"),s(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"#将需要删除的key发送消息队列\")]),t._v(\"\\n\"),s(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"#自己消费消息，获得要删除的key\")]),t._v(\"\\n\"),s(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"#继续重试删除，直到成功\")]),t._v(\"\\n\")])])]),s(\"div\",{staticClass:\"custom-block tip\"},[s(\"p\",{staticClass:\"custom-block-title\"},[t._v(\"TIP\")]),t._v(\" \"),s(\"p\",[t._v(\"该方案有一个缺点，对业务线代码造成大量的侵入\")])]),t._v(\" \"),s(\"ul\",[s(\"li\",[t._v(\"方案2\")])]),t._v(\" \"),s(\"div\",{staticClass:\"language-sh extra-class\"},[s(\"pre\",{pre:!0,attrs:{class:\"language-sh\"}},[s(\"code\",[s(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"#更新数据库数据,数据库会将操作信息写入binlog日志中\")]),t._v(\"\\n\"),s(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"#订阅程序提取出来所需要的数据以及key\")]),t._v(\"\\n\"),s(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"#另起一段非业务代码，获得该信息\")]),t._v(\"\\n\"),s(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"#尝试删除缓存操作，发现删除失败\")]),t._v(\"\\n\"),s(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"#将这些信息发送消息队列\")]),t._v(\"\\n\"),s(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"#重新从消息队列获取该数据，重试操作\")]),t._v(\"\\n\")])])]),s(\"div\",{staticClass:\"custom-block tip\"},[s(\"p\",{staticClass:\"custom-block-title\"},[t._v(\"TIP\")]),t._v(\" \"),s(\"p\",[t._v(\"上述的订阅binlog程序在mysql中有现成的中间件叫canal，可以完成订阅binlog日志的功能\")])]),t._v(\" \"),s(\"h3\",{attrs:{id:\"性能指标监控\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#性能指标监控\"}},[t._v(\"#\")]),t._v(\" 性能指标监控\")]),t._v(\" \"),s(\"h4\",{attrs:{id:\"监控指标\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#监控指标\"}},[t._v(\"#\")]),t._v(\" 监控指标\")]),t._v(\" \"),s(\"ul\",[s(\"li\",[t._v(\"性能指标：Performance\")]),t._v(\" \"),s(\"li\",[t._v(\"内存指标：Memory\")]),t._v(\" \"),s(\"li\",[t._v(\"基本活动指标：Basicactivity\")]),t._v(\" \"),s(\"li\",[t._v(\"持久性指标：Persistence\")]),t._v(\" \"),s(\"li\",[t._v(\"错误指标：Error\")])]),t._v(\" \"),s(\"h4\",{attrs:{id:\"性能指标：performance\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#性能指标：performance\"}},[t._v(\"#\")]),t._v(\" 性能指标：Performance\")]),t._v(\" \"),s(\"table\",[s(\"thead\",[s(\"tr\",[s(\"th\",[t._v(\"NAME\")]),t._v(\" \"),s(\"th\",{staticStyle:{\"text-align\":\"center\"}},[t._v(\"DESC\")])])]),t._v(\" \"),s(\"tbody\",[s(\"tr\",[s(\"td\",[t._v(\"latency\")]),t._v(\" \"),s(\"td\",{staticStyle:{\"text-align\":\"center\"}},[t._v(\"redis响应一个请求的时间\")])]),t._v(\" \"),s(\"tr\",[s(\"td\",[t._v(\"OPS\")]),t._v(\" \"),s(\"td\",{staticStyle:{\"text-align\":\"center\"}},[t._v(\"每秒处理请求总数\")])]),t._v(\" \"),s(\"tr\",[s(\"td\",[t._v(\"hit rate\")]),t._v(\" \"),s(\"td\",{staticStyle:{\"text-align\":\"center\"}},[t._v(\"缓存命中率（计算出来的）\")])])])]),t._v(\" \"),s(\"h4\",{attrs:{id:\"内存指标：memory\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#内存指标：memory\"}},[t._v(\"#\")]),t._v(\" 内存指标：Memory\")]),t._v(\" \"),s(\"table\",[s(\"thead\",[s(\"tr\",[s(\"th\",[t._v(\"NAME\")]),t._v(\" \"),s(\"th\",{staticStyle:{\"text-align\":\"center\"}},[t._v(\"DESC\")])])]),t._v(\" \"),s(\"tbody\",[s(\"tr\",[s(\"td\",[t._v(\"used_memory\")]),t._v(\" \"),s(\"td\",{staticStyle:{\"text-align\":\"center\"}},[t._v(\"已使用内存\")])]),t._v(\" \"),s(\"tr\",[s(\"td\",[t._v(\"mem_fragmentation_ratio\")]),t._v(\" \"),s(\"td\",{staticStyle:{\"text-align\":\"center\"}},[t._v(\"内存碎片率\")])]),t._v(\" \"),s(\"tr\",[s(\"td\",[t._v(\"evicted_keys\")]),t._v(\" \"),s(\"td\",{staticStyle:{\"text-align\":\"center\"}},[t._v(\"由于内存限制而被移除key数量\")])]),t._v(\" \"),s(\"tr\",[s(\"td\",[t._v(\"blocked clients\")]),t._v(\" \"),s(\"td\",{staticStyle:{\"text-align\":\"center\"}},[t._v(\"由于BLPOP、BRPOP等命令而阻塞的客户端\")])])])]),t._v(\" \"),s(\"h4\",{attrs:{id:\"基本活动指标：basicactivity\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#基本活动指标：basicactivity\"}},[t._v(\"#\")]),t._v(\" 基本活动指标：Basicactivity\")]),t._v(\" \"),s(\"table\",[s(\"thead\",[s(\"tr\",[s(\"th\",[t._v(\"NAME\")]),t._v(\" \"),s(\"th\",{staticStyle:{\"text-align\":\"center\"}},[t._v(\"DESC\")])])]),t._v(\" \"),s(\"tbody\",[s(\"tr\",[s(\"td\",[t._v(\"connected_clients\")]),t._v(\" \"),s(\"td\",{staticStyle:{\"text-align\":\"center\"}},[t._v(\"客户端连接数\")])]),t._v(\" \"),s(\"tr\",[s(\"td\",[t._v(\"connected_slaves\")]),t._v(\" \"),s(\"td\",{staticStyle:{\"text-align\":\"center\"}},[t._v(\"slave数量\")])]),t._v(\" \"),s(\"tr\",[s(\"td\",[t._v(\"master_last_io_senconds_ago\")]),t._v(\" \"),s(\"td\",{staticStyle:{\"text-align\":\"center\"}},[t._v(\"最近一次主从交互之后的秒数\")])]),t._v(\" \"),s(\"tr\",[s(\"td\",[t._v(\"keyspace\")]),t._v(\" \"),s(\"td\",{staticStyle:{\"text-align\":\"center\"}},[t._v(\"数据库key总数\")])])])]),t._v(\" \"),s(\"h4\",{attrs:{id:\"持久性指标：persistence\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#持久性指标：persistence\"}},[t._v(\"#\")]),t._v(\" 持久性指标：Persistence\")]),t._v(\" \"),s(\"table\",[s(\"thead\",[s(\"tr\",[s(\"th\",[t._v(\"NAME\")]),t._v(\" \"),s(\"th\",{staticStyle:{\"text-align\":\"center\"}},[t._v(\"DESC\")])])]),t._v(\" \"),s(\"tbody\",[s(\"tr\",[s(\"td\",[t._v(\"rdb_last_save_time\")]),t._v(\" \"),s(\"td\",{staticStyle:{\"text-align\":\"center\"}},[t._v(\"最后一次保存到磁盘的时间戳\")])]),t._v(\" \"),s(\"tr\",[s(\"td\",[t._v(\"rdb_changes_since_last_save\")]),t._v(\" \"),s(\"td\",{staticStyle:{\"text-align\":\"center\"}},[t._v(\"自最后一次持久化磁盘后的更改数\")])])])]),t._v(\" \"),s(\"h4\",{attrs:{id:\"错误指标：error\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#错误指标：error\"}},[t._v(\"#\")]),t._v(\" 错误指标：Error\")]),t._v(\" \"),s(\"table\",[s(\"thead\",[s(\"tr\",[s(\"th\",[t._v(\"NAME\")]),t._v(\" \"),s(\"th\",{staticStyle:{\"text-align\":\"center\"}},[t._v(\"DESC\")])])]),t._v(\" \"),s(\"tbody\",[s(\"tr\",[s(\"td\",[t._v(\"rejected_connections\")]),t._v(\" \"),s(\"td\",{staticStyle:{\"text-align\":\"center\"}},[t._v(\"由于达到最大连接数maxcliens限制而被拒绝的连接数\")])]),t._v(\" \"),s(\"tr\",[s(\"td\",[t._v(\"keyspace_misses\")]),t._v(\" \"),s(\"td\",{staticStyle:{\"text-align\":\"center\"}},[t._v(\"key值查找未命中数\")])]),t._v(\" \"),s(\"tr\",[s(\"td\",[t._v(\"master_link_down_since_seconds\")]),t._v(\" \"),s(\"td\",{staticStyle:{\"text-align\":\"center\"}},[t._v(\"主从断开的秒数\")])])])]),t._v(\" \"),s(\"h3\",{attrs:{id:\"性能指标监控命令\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#性能指标监控命令\"}},[t._v(\"#\")]),t._v(\" 性能指标监控命令\")]),t._v(\" \"),s(\"h4\",{attrs:{id:\"监控工具\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#监控工具\"}},[t._v(\"#\")]),t._v(\" 监控工具\")]),t._v(\" \"),s(\"ul\",[s(\"li\",[t._v(\"cloud insight redis\")]),t._v(\" \"),s(\"li\",[t._v(\"Prometheus\")]),t._v(\" \"),s(\"li\",[t._v(\"Redis-stat\")]),t._v(\" \"),s(\"li\",[t._v(\"Redis-faina\")]),t._v(\" \"),s(\"li\",[t._v(\"RedisLive\")]),t._v(\" \"),s(\"li\",[t._v(\"Zabbix\")])]),t._v(\" \"),s(\"h4\",{attrs:{id:\"监控命令\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#监控命令\"}},[t._v(\"#\")]),t._v(\" 监控命令\")]),t._v(\" \"),s(\"ul\",[s(\"li\",[t._v(\"benchmark\")])]),t._v(\" \"),s(\"div\",{staticClass:\"language-sh extra-class\"},[s(\"pre\",{pre:!0,attrs:{class:\"language-sh\"}},[s(\"code\",[s(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"#50个连接，10000次请求对应性能\")]),t._v(\"\\nredis-benchmark\\n\"),s(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"#100个连接，5000次请求对应性能\")]),t._v(\"\\nredis-benchmark -c \"),s(\"span\",{pre:!0,attrs:{class:\"token number\"}},[t._v(\"100\")]),t._v(\" -n \"),s(\"span\",{pre:!0,attrs:{class:\"token number\"}},[t._v(\"5000\")]),t._v(\"\\n\")])])]),s(\"ul\",[s(\"li\",[t._v(\"redis cli\\n\"),s(\"ul\",[s(\"li\",[t._v(\"monitor\")]),t._v(\" \"),s(\"li\",[t._v(\"showlog\")])])])]),t._v(\" \"),s(\"div\",{staticClass:\"language-sh extra-class\"},[s(\"pre\",{pre:!0,attrs:{class:\"language-sh\"}},[s(\"code\",[s(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"#命令 get 获取慢查询日志 len 获取慢查询条数 reset重置慢查询日志\")]),t._v(\"\\nshowlog \"),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"[\")]),t._v(\"operator\"),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"]\")]),t._v(\"\\n \"),s(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"#相关配置\")]),t._v(\"\\n slowlog-log-slower-than \"),s(\"span\",{pre:!0,attrs:{class:\"token number\"}},[t._v(\"1000\")]),t._v(\" \"),s(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"#设置慢查询时间下限\")]),t._v(\"\\n slowlog-max-len \"),s(\"span\",{pre:!0,attrs:{class:\"token number\"}},[t._v(\"100\")]),t._v(\" \"),s(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"#设置慢查询命令对应日志显示长度\")]),t._v(\"\\n````+\")])])])])}),[],!1,null,null,null);a.default=v.exports}}]);","extractedComments":[]}